import fs from 'node:fs/promises';
import path from 'node:path';
import {fileURLToPath} from 'node:url';

import {resolveMetaFileAbsPath} from './lib/resolve-meta-path.mjs';

const scriptDir = path.dirname(fileURLToPath(import.meta.url));
const repoRoot = path.resolve(scriptDir, '..', '..');
const coursesRoot = path.join(repoRoot, 'courses');
const outFile = path.join(repoRoot, 'remotion', 'src', 'lesson-manifest.ts');

const toPosix = (p) => p.split(path.sep).join('/');
const isLessonMetaFileName = (name) => /^lesson\.meta(\.[a-z0-9-]+)?\.json$/i.test(name);

const walk = async (dir) => {
  const entries = await fs.readdir(dir, {withFileTypes: true});
  const results = [];
  for (const entry of entries) {
    const full = path.join(dir, entry.name);
    if (entry.isDirectory()) {
      results.push(...(await walk(full)));
      continue;
    }
    if (entry.isFile() && isLessonMetaFileName(entry.name)) {
      results.push(full);
    }
  }
  return results;
};

const files = await walk(coursesRoot);
files.sort((a, b) => a.localeCompare(b));

const manifest = [];
for (const abs of files) {
  const raw = await fs.readFile(abs, 'utf8');
  const meta = JSON.parse(raw);
  const id = String(meta.id ?? '').trim();
  if (!id) {
    throw new Error(`Missing "id" in ${abs}`);
  }
  const rel = toPosix(path.relative(coursesRoot, abs));

  const fps = Number(meta.fps ?? 30);
  const width = Number(meta.resolution?.width ?? 1920);
  const height = Number(meta.resolution?.height ?? 1080);
  const coverFrames = meta.cover?.enabled ? Number(meta.cover?.durationFrames ?? 0) : 0;
  const outroFrames = meta.outro?.enabled ? Number(meta.outro?.durationFrames ?? 0) : 0;

  let contentFrames = 1;
  const timingsRel = meta.assets?.segmentTimings;
  if (typeof timingsRel === 'string' && timingsRel.trim()) {
    const timingsAbs =
      resolveMetaFileAbsPath({
        repoRoot,
        coursesRoot,
        metaAbsPath: abs,
        value: timingsRel,
      }) ?? path.join(coursesRoot, timingsRel);
    try {
      const timingsRaw = await fs.readFile(timingsAbs, 'utf8');
      const timings = JSON.parse(timingsRaw);
      if (Array.isArray(timings) && timings.length) {
        const last = timings[timings.length - 1];
        const endMs = Number(last.startMs) + Number(last.durationMs);
        if (Number.isFinite(endMs) && endMs >= 0) {
          contentFrames = Math.max(1, Math.ceil((endMs / 1000) * fps));
        }
      }
    } catch {
      // Missing timings is fine: manifest will still be generated with duration 1.
    }
  }

  const durationInFrames =
    contentFrames + Math.max(0, coverFrames) + Math.max(0, outroFrames);

  manifest.push({
    id,
    metaFile: rel,
    fps,
    width,
    height,
    durationInFrames,
  });
}

const fileContents = `// AUTO-GENERATED by bun scripts/build-lesson-manifest.mjs.
// Do not edit manually.

export type LessonManifestEntry = {
  id: string;
  metaFile: string;
  fps: number;
  width: number;
  height: number;
  durationInFrames: number;
};

export const lessonManifest: LessonManifestEntry[] = ${JSON.stringify(
  manifest,
  null,
  2,
)};
`;

await fs.writeFile(outFile, fileContents, 'utf8');
console.log(`Wrote ${manifest.length} lesson(s) to ${path.relative(repoRoot, outFile)}`);
