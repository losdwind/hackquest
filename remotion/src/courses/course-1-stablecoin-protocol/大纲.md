# 课程一：稳定币协议开发实战课

你每天都在用稳定币（USDT、USDC、DAI）。它们是加密世界的大动脉。

有没有想过，自己造一个？

结课时，你会部署一个可审计、生产级的超额抵押稳定币协议，包含自动清算、稳定费率和稳定池兜底。

## 你会学到

- 稳定币三维分类：为什么 UST 会死而 DAI 能活（外生 vs 内生抵押）。
- CDP 架构设计：抵押债仓、健康因子、清算博弈的底层逻辑。
- 预言机安全：Chainlink 集成、陈旧价格保护、极端行情熔断。
- 稳定费率机制：Ray Math 复利计算，让协议产生收入。
- 稳定池兜底：极端行情下坏账处理。
- 生产级测试：Fuzz + Invariant Testing。

## 你会做什么

- 完整的 CDP 引擎（存 ETH，借出你的稳定币）。
- 清算机制（健康因子破裂触发清算，清算人赚 10% 奖励）。
- Chainlink 预言机 + OracleLib 安全库集成。
- 链下监控脚本与清算机会检测（TypeScript + viem）。
- 测试网部署与安全自查（Slither）。

## 前置要求

熟悉 Solidity，了解 ERC20 和基础 DeFi；有 JS/TS 经验更佳。

## Part 1：背景知识 - 稳定币原理（6 讲）

1. DeFi 生态全景：MakerDAO/Aave/Uniswap 定位，稳定币在 DeFi 中的地位。
2. 稳定币三维分类法：锚定 vs 浮动 / 治理 vs 算法 / 外生 vs 内生抵押。
3. CDP 核心概念：抵押债仓，超额抵押率，为什么是 150%。
4. 清算机制原理：健康因子详解，清算人激励与博弈。
5. 预言机依赖与攻击：Chainlink 原理，陈旧价格攻击，闪电贷操纵。
6. 为什么有些稳定币会死：外生 vs 内生抵押的生死线。
   - DAI/LUSD 为什么活着：外生抵押，价格下跌可卖抵押还债。
   - UST 为什么死了：内生抵押，价格下跌导致死亡螺旋。
   - 设计决策：选择外生抵押（wETH/wBTC）。

## Part 2：进阶技术 - 协议实现（17 讲）

模块 A：稳定币代币合约

6. 项目架构设计：DSC + DSCEngine 分离设计。
7. 稳定币代币实现：ERC20Burnable + Ownable，铸造/销毁权限控制。
8. 抵押品管理：多抵押品（wETH/wBTC）与白名单设计。

模块 B：CDP 引擎核心

9. 存款与铸造：depositCollateralAndMintDsc 核心逻辑。
   - CEI 模式防重入。
   - moreThanZero / isAllowedToken 修饰符设计。
10. 赎回与销毁：redeemCollateralForDsc 原子操作。
    - 先销毁债务再赎回抵押品。
    - _redeemCollateral 内部复用。
11. 健康因子计算：_healthFactor 与最小抵押率。
    - 精度处理：Chainlink 8 位 vs ERC20 18 位。
    - 常量设计：LIQUIDATION_THRESHOLD / PRECISION。
12. Chainlink 预言机集成：价格聚合、心跳检测、陈旧保护。

模块 C：清算系统

13. 清算函数实现：liquidate 逻辑链。
    - 检查健康因子 < 1。
    - 计算债务与清算奖励（10%）。
    - 转移抵押品并销毁债务。
    - 验证双方健康因子。
14. 清算边界条件：部分清算 vs 全额清算。
    - 清算人保护。
    - 抵押品不足的兜底策略。
15. OracleLib 安全库：最后防线。
    - 过期价格直接 revert。
16. 紧急机制：极端行情协议保护。
    - 单区块价格波动熔断。
    - 治理升级：Ownable vs 多签 vs 时间锁。

模块 D：经济模型与风险兜底

17. 稳定费率机制：让协议产生收入。
    - 累积利率指数（Accumulator Pattern）。
    - Ray Math 精度（1e27）。
    - globalDebtIndex / normalizedDebt / _accrueInterest 设计。
18. 稳定池机制：极端行情坏账处理。  
    - Liquity 思路与存款人收益分配。
    - 修改清算流程支持稳定池。
19. 预言机冗余与熔断：多源价格校验。
    - Chainlink + Uniswap V3 TWAP 交叉验证。
    - 价格偏差阈值暂停铸造。

模块 E：生产级测试

20. Foundry 测试框架：单测结构、Mock、HelperConfig。
21. Fuzz Testing 实战：用 Fuzzer 找边界。
22. Invariant Testing：系统安全证明。
    - 定义不变量：抵押品总价值 > DSC 总供应。
    - Handler-based Testing 与 Ghost Variables。
    - 真实 Bug 发现案例。

## Part 3：部署·监控·审计（5 讲）

23. 完善协议事件：监控与前端准备。
24. 部署脚本与多网络配置：DeployDSC + HelperConfig。
25. 链下监控脚本：监听事件与健康因子。
26. 清算机会检测：收益估算与 MEV 入门。
27. 安全审计准备：Slither 扫描与审计清单。

## 交付物

- 完整 CDP 稳定币协议源码（DSC + DSCEngine + OracleLib）。
- 稳定费率模块与累积利率计算。
- 稳定池合约与极端行情兜底机制。
- 生产级 Foundry 测试（单测 + Fuzz + Invariant）。
- 多网络部署脚本。
- 链下监控与清算机会检测脚本。
- 安全审计 Checklist + Slither 报告。

## 课程衔接预告

你的稳定币可以怎么用？

- PayFi 课程：让用户用你的稳定币支付 API 费用。
- AI Agent 课程：让 Agent 用你的稳定币自动调仓。
