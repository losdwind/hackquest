# 课程一：稳定币协议开发实战课（v2）

你每天都在用稳定币（USDT、USDC、DAI）。它们是加密世界的大动脉。

有没有想过，自己造一个？

结课时，你会部署一个可审计、生产级的超额抵押稳定币协议，包含自动清算、稳定费率和稳定池兜底。


## 你会学到

稳定币三维分类：为什么 UST 会死而 DAI 能活（外生 vs 内生抵押）。
CDP 架构设计：抵押债仓、健康因子、清算博弈的底层逻辑。
预言机安全：Chainlink 集成、陈旧价格保护、极端行情熔断。
稳定费率机制：Ray Math 复利计算，让协议产生收入。
稳定池兜底：极端行情下坏账处理。
生产级测试：Fuzz + Invariant Testing。


## 你会做什么

完整的 CDP 引擎（存 ETH，借出你的稳定币）。
清算机制（健康因子破裂触发清算，清算人赚 10% 奖励）。
Chainlink 预言机 + OracleLib 安全库集成。
链下监控脚本与清算机会检测（TypeScript + viem）。
测试网部署与安全自查（Slither）。


## 前置要求

熟悉 Solidity，了解 ERC20 和基础 DeFi；有 JS/TS 经验更佳。


## Part 1：破冰 - 稳定币为什么重要（2 讲）

心理目标：建立动机，"这事跟我有关"。

1. DeFi 生态全景
   钩子：2022 年 5 月，UST 崩盘蒸发 400 亿美元。有人破产，有人做空赚了 8 位数。
   内容：MakerDAO / Aave / Uniswap 定位，稳定币在 DeFi 中的地位。
   悬念：为什么同样是稳定币，UST 死了，DAI 还活着？

2. 稳定币三维分类法
   内容：锚定 vs 浮动 / 治理 vs 算法 / 外生 vs 内生抵押。
   格局观：外生抵押是生存线，内生抵押是死亡螺旋的入口。
   设计决策预告：我们选择外生抵押（wETH/wBTC）。


## Part 2：快速胜利 - 先跑通再说（1 讲）

心理目标：建立自信，"我能学会"。

3. 10 分钟体验完整协议
   动作：克隆 Starter Repo，运行 forge build，执行测试脚本。
   即时反馈：看到"存入 1 ETH，铸造 500 DSC"的成功输出。
   类比：这就像去银行存黄金换现金，银行就是你的智能合约。
   过渡：接下来我们拆解这个协议是怎么工作的。


## Part 3：认知支架 - 核心概念（4 讲）

心理目标：建立宏观认识，为深水区做准备。

4. CDP 核心概念
   内容：抵押债仓，超额抵押率，为什么是 150%。

5. 清算机制原理
   内容：健康因子详解，清算人激励与博弈。

6. 预言机依赖与攻击
   内容：Chainlink 原理，陈旧价格攻击，闪电贷操纵。

7. 为什么有些稳定币会死
   内容：DAI/LUSD 为什么活着（外生抵押），UST 为什么死了（内生抵押）。
   过渡：现在你理解了原理，我们开始动手实现。


## Part 4：深水区 - 协议实现（16 讲）

心理目标：深度理解，攻克技术卡点。每节控制在 20 分钟内。

模块 A：稳定币代币合约（3 讲）

8. 项目架构设计
   内容：DSC + DSCEngine 分离设计。

9. 稳定币代币实现
   内容：ERC20Burnable + Ownable，铸造/销毁权限控制。

10. 抵押品管理
    内容：多抵押品（wETH/wBTC）与白名单设计。

模块 B：CDP 引擎核心（4 讲）

11. 存款与铸造
    内容：depositCollateralAndMintDsc 核心逻辑，CEI 模式防重入，修饰符设计。

12. 赎回与销毁
    内容：redeemCollateralForDsc 原子操作，先销毁债务再赎回抵押品。

13. 健康因子计算
    内容：_healthFactor 与最小抵押率，精度处理（Chainlink 8 位 vs ERC20 18 位）。

14. Chainlink 预言机集成
    内容：价格聚合、心跳检测、陈旧保护。

模块 C：清算系统（4 讲）

15. 清算函数实现
    内容：liquidate 逻辑链（检查健康因子 -> 计算奖励 -> 转移抵押品 -> 销毁债务）。

16. 清算边界条件
    内容：部分清算 vs 全额清算，清算人保护，抵押品不足的兜底策略。

17. OracleLib 安全库
    内容：过期价格直接 revert，最后防线设计。

18. 紧急机制
    内容：单区块价格波动熔断，治理升级（Ownable vs 多签 vs 时间锁）。

模块 D：经济模型与风险兜底（3 讲）

19. 稳定费率机制
    内容：累积利率指数（Accumulator Pattern），Ray Math 精度（1e27）。
    行业八卦：MakerDAO 年收入 1 亿美元，全靠这个数学公式。

20. 稳定池机制
    内容：极端行情坏账处理，Liquity 思路与存款人收益分配。

21. 预言机冗余与熔断
    内容：Chainlink + Uniswap V3 TWAP 交叉验证，价格偏差阈值暂停铸造。

模块 E：生产级测试（2 讲）

22. Fuzz Testing 实战
    内容：Foundry 测试框架，用 Fuzzer 找边界。

23. Invariant Testing
    内容：定义不变量（抵押品总价值 > DSC 总供应），Handler-based Testing。
    过渡：协议写完了，接下来看看真实世界里怎么用它赚钱。


## Part 5：迁移 - 从代码到实战（2 讲）

心理目标：用学到的知识解决真实问题。

24. 链下监控脚本
    内容：TypeScript + viem 监听事件与健康因子。
    即时反馈：终端实时打印接近清算的仓位。

25. 清算机会检测
    内容：收益估算与 MEV 入门。
    洞察：有人靠清算机器人月入 6 位数，他们的代码逻辑和你刚写的一样。
    过渡：能发现机会了，最后把协议部署上线。


## Part 6：成就闭环 - 部署与审计（2 讲）

心理目标：完成交付，指向下一步行动。

26. 部署脚本与事件完善
    内容：DeployDSC + HelperConfig，多网络配置，监控与前端准备。

27. 安全审计准备
    内容：Slither 扫描与审计清单。
    身份升级：你已经不是"学 Solidity 的人"，而是"能独立开发 DeFi 协议的工程师"。


## 交付物

完整 CDP 稳定币协议源码（DSC + DSCEngine + OracleLib）
稳定费率模块与累积利率计算
稳定池合约与极端行情兜底机制
生产级 Foundry 测试（单测 + Fuzz + Invariant）
多网络部署脚本
链下监控与清算机会检测脚本
安全审计 Checklist + Slither 报告


## 课程衔接预告

你的稳定币可以怎么用？

PayFi 课程：让用户用你的稳定币支付 API 费用。
AI Agent 课程：让 Agent 用你的稳定币自动调仓。
